name: Build Minecraft Plugin

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  lint-actions:
    name: ğŸ§¹ Lint Actions
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@main
      - uses: devops-actions/actionlint@main

  lint-links:
    name: ğŸ§¹ Lint Links
    runs-on: ubuntu-latest

    permissions:
      checks: write

    steps:
      - uses: actions/checkout@main

      - uses: umbrelladocs/action-linkspector@main
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          fail_level: error

  lint-markdown:
    name: ğŸ§¹ Lint Markdown
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@main

      - uses: DavidAnson/markdownlint-cli2-action@main
        with:
          globs: '**/*.md'
          fix: true
          config: '.markdownlint.jsonc'

  security-scan:
    name: ğŸ” Security Scan CodeQL
    runs-on: ubuntu-latest

    permissions:
      actions: read
      security-events: write

    steps:
      - uses: actions/checkout@main

      - uses: github/codeql-action/init@v3
        with:
          languages: java-kotlin
          queries: security-and-quality

      - uses: actions/setup-java@main
        with:
          java-version: 17
          distribution: 'temurin'

      - uses: gradle/actions/setup-gradle@main

      - run: ./gradlew build -x test

      - uses: github/codeql-action/analyze@v3

  security-scan-trivy:
    name: ğŸ” Security Scan Trivy
    runs-on: ubuntu-latest

    permissions:
      security-events: write

    steps:
      - uses: actions/checkout@main

      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        if: github.event.pull_request.head.repo.fork == false
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  security-scan-osv:
    name: ğŸ” Security Scan OSV

    if: github.event.pull_request.head.repo.fork == false

    permissions:
      contents: read
      actions: read
      security-events: write

    uses: google/osv-scanner-action/.github/workflows/osv-scanner-reusable-pr.yml@v2.2.3
    with:
      fail-on-vuln: true
      scan-args: |-
        --allow-no-lockfiles
        --recursive
        ./

  dependency-review:
    name: ğŸ§© Dependency Review
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - uses: actions/checkout@main

      - uses: actions/dependency-review-action@main
        with:
          fail-on-severity: high

  secrets-scan:
    name: ğŸ”‘ Secrets Scan TruffleHog
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@main
        with:
          fetch-depth: 0

      - uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --results=verified,unknown

  build:
    name: ğŸ—ï¸ Build Plugin

    needs: [
      lint-actions,
      lint-links,
      lint-markdown,
      security-scan,
      security-scan-trivy,
      security-scan-osv,
      dependency-review,
      secrets-scan
    ]

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@main

      - run: chmod +x gradlew

      - uses: actions/setup-java@main
        with:
          java-version: 17
          distribution: 'temurin'

      - uses: gradle/actions/setup-gradle@main

      - run: ./gradlew build

      - uses: actions/upload-artifact@main
        with:
          name: MMOSpawnPoint
          path: ${{ github.workspace }}/build/libs/